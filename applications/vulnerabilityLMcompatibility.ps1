################################################################################################################
# This script is to remediate and vulnerability reported in Rapid 7 for Windows 10 as Weak LAN Manager hashing permitted.
# The script checks if HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\LMCompatibilityLevel key exists with a dword of 5.
# If the LMCompatibilityLevel key already exists it checks that it has a dword value of 5 and changes it if necessary.
# If the LMCompatibilityLevel key does not exist it creates it with a dword value of 5.
# A log of this activity is written to C:\Temp\lmcompatibility.txt.
################################################################################################################

#Start of Log Function
$logfile = "C:\Temp\lmcompatibility.txt"
function Write-ToLog
{
    Param ([string]$logstring)
    $timestamp = (Get-Date).tostring("yyyy/MM/dd HH:mm:ss")
    Add-Content $Logfile -value "$logstring $timestamp"
}
#End of Log Function

$path = "HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\"
Write-ToLog "Checking for LMCompatibility key with value of 5 at $path for vulnerability remediation"
try {
    $regValue = Get-ItemProperty -path $path -Name 'LMCompatibilityLevel' -ErrorAction Stop
    if ($regvalue.lmcompatibilitylevel -eq 5) {
        write-host "$(Get-Date) AIB Customization: LMCompatibilityLevel settings key was found at $path with a setting of 5"
        Add-Content -LiteralPath C:\New-SessionHostImage.log "$(Get-Date) AIB Customization: LMCompatibilityLevel settings key was found at $path with a setting of 5"
    }
    else {
        Set-ItemProperty -path $path -name "LMCompatibilityLevel" -Value 5
        write-host "$(Get-Date) AIB Customization: LMCompatibilityLevel settings key was found at $path and was changed to 5"
        Add-Content -LiteralPath C:\New-SessionHostImage.log "$(Get-Date) AIB Customization: LMCompatibilityLevel settings key was found at $path and was changed to 5"
    }
}
catch {
        New-ItemProperty -path $path -Name "LMCompatibilityLevel" -PropertyType "DWORD" -Value 5 -ErrorAction Stop
        write-host "$(Get-Date) AIB Customization: LMCompatibilityLevel settings key was not found at $path and was created with a setting of 5"
        Add-Content -LiteralPath C:\New-SessionHostImage.log "$(Get-Date) AIB Customization: LMCompatibilityLevel settings key was not found at $path and was created with a setting of 5"
}
