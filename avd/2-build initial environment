# make sure to Connect-AzAccount AND set your context if you are doing a redeploy, skipped 1-prerequisites, or have multiple subscriptions
# building our variables, base environment, and compute gallery.

# get existing Azure account context
$currentAzContext = Get-AzContext

# get your current subscription ID
$subscriptionID = $currentAzContext.Subscription.Id

# the Azure region to deploy to. Region names: Get-AzLocation | Select-Object Location | Sort-Object Location
$location = "eastus"

# whatever you want to name your destination image resource group and then create it.
$imageResourceGroup = "RG-AIB1EastUS"
New-AzResourceGroup -Name $imageResourceGroup -Location $location

# create a managed identity
$identityName="ImageBuilderAIB1EastUS"
New-AzUserAssignedIdentity -ResourceGroupName $imageResourceGroup -Name $identityName -Location $location
$identityNamePrincipalId = $(Get-AzUserAssignedIdentity -ResourceGroupName $imageResourceGroup -Name $identityName).PrincipalId

# create and assign custom role to the managed identity that allows it to manipulate images inside only this resource group
$imageRoleDefName="AIB Contributor AIB1EastUS"
$aibRoleImageCreationUrl="https://raw.githubusercontent.com/OtterDoom/AzureImageBuild/main/avd/aibRoleImageCreation.json"
$aibRoleImageCreationPath = "aibRoleImageCreation.json"

# download custom role configuration
Invoke-WebRequest -Uri $aibRoleImageCreationUrl -OutFile $aibRoleImageCreationPath -UseBasicParsing
((Get-Content -path $aibRoleImageCreationPath -Raw) -replace '<subscriptionID>',$subscriptionID) | Set-Content -Path $aibRoleImageCreationPath
((Get-Content -path $aibRoleImageCreationPath -Raw) -replace '<rgName>', $imageResourceGroup) | Set-Content -Path $aibRoleImageCreationPath
((Get-Content -path $aibRoleImageCreationPath -Raw) -replace 'Azure Image Builder Service Image Creation Role', $imageRoleDefName) | Set-Content -Path $aibRoleImageCreationPath

# create role definition
New-AzRoleDefinition -InputFile  ./aibRoleImageCreation.json
# Wait here for last step to finish

# grant role definition to image builder service principal
New-AzRoleAssignment -ObjectId $identityNamePrincipalId -RoleDefinitionName $imageRoleDefName -Scope "/subscriptions/$subscriptionID/resourceGroups/$imageResourceGroup"

### NOTE: If you see this error: 'New-AzRoleDefinition: Role definition limit exceeded. No more role definitions can be created.' See this article to resolve:
# https://docs.microsoft.com/en-us/azure/role-based-access-control/troubleshooting

# create gallery# whatever you want to name your image gallery
$sigGalleryName = "AIBGallery1EastUS"
New-AzGallery -GalleryName $sigGalleryName -ResourceGroupName $imageResourceGroup -Location $location